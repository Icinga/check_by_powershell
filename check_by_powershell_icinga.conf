object Host "windowshost" {
  import "generic-host"

  address = "192.168.172.217"
  vars.powershell_port = 5985
  vars.powershell_user = "windowsuser"
  vars.powershell_password = "secret!pw"
  vars.powershell_tls = true
  vars.powershell_unsecure = true

  vars.server_type = "windows"
}

object CheckCommand "powershell" {
  command = [ PluginDir + "/check_by_powershell" ]

  arguments = {
    "-H" = {
      value = "$address$"
      description = "Host name, IP Address of the remote host"
    }
    "-p" = {
      value = "$powershell_port$"
      description = "Port number WinRM"
    }
    "--user" = {
      value = "$powershell_user$"
      description = "Username of the remote host"
    }
    "--password" = {
      value = "$powershell_password$"
      description = "Password of the user"
    }
    "--tls" = {
      value = "$powershell_tls$"
      description = "Use TLS connection"
    }
    "--unsecure" = {
      value = "$powershell_unsecure$"
      description = "Verify the hostname on the returned certificate"
    }
    "--ca" = {
      value = "$powershell_ca$"
      description = "CA certificate"
    }
    "--cert" = {
      value = "$powershell_cert$"
      description = "Client certificate"
    }
    "--key" = {
      value = "$powershell_key$"
      description = "Client key"
    }
    "--icingacmd" = {{
      var command = macro("$by_powershell_command$")
      var arguments = macro("$by_powershell_arguments$")
      if (typeof(command) == String && !arguments) {
          return command
      }

      var escaped_args = []
      for (arg in resolve_arguments(command, arguments)) {
           escaped_args.add(arg)
      }
      return escaped_args.join(" ")
      description = "Executes commands of Icinga PowerShell Framework"
    }}
    "--cmd" = {
      value = "$powershell_cmd$"
      description = "Command to execute on the remote machine"
    }
    "--auth" = {
      value = "$powershell_auth$"
      description = "Authentication mechanism - NTLM | SSH"
    }
    "--sshhost" = {
      value = "$powershell_sshhost$"
      description = "SSH Host"
    }
    "--sshuser" = {
      value = "$powershell_sshuser$"
      description = "SSH Username"
    }
    "--sshpassword" = {
      value = "$powershell_sshpassword$"
      description = "SSH Password"
    }
  }
}

object CheckCommand "powershell-checkTime-sync" {
  import "plugin-check-command"

  command = [
       "Invoke-IcingaCheckTimeSync"
  ]

  arguments = {
      "-Server" = {
          value = "$powershell_ntp_server$"
          description = "The NTP server you want to connect to"
      }
      "-TimeOffset" = {
          value = "$powershell_timeoffset$"
          description = "Expected offset of the ntp server relative to local server(seconds)."
      }
      "-Warning" = {
          value = "$powershell_warning$"
          description = "Offset to result in warning status e.g(10ms or 0.01s)"
      }
      "-Critical" = {
          value = "$powershell_critical$"
          description = "Offset to result in critical status e.g(60ms or 0.06s)"
      }
      "-Timeout" = {
          value = "$powershell_timeout$"
          description = "Seconds before connection times out (default: 10)"
      }
      "-IPV4" = {
          set_if = "$powershell_server_ipv4$"
          description = "Use IPv4 connection. Default to false"
      }
      "-Port" = {
          value = "$powershell_ntp_port$"
          description = "Port number ntp server"
      }
      "-NoPerfData" = {
          set_if = "$powershell_perfdata$"
          description = "No Performance data. Default to false"
      }
      "-Verbosity" = {
          value = "$powershell_verbosity$"
          description = "Set Plugin Output to verbose mode. Default 0"
      }
   }
}

template Service "powershell-template-service" {
   import "generic-service"

   vars.original_check_command = check_command
   check_command = "powershell"

   vars.by_powershell_command = {{ get_check_command(service.vars.original_check_command).command }}
   vars.by_powershell_arguments = {{ get_check_command(service.vars.original_check_command).arguments }}
}

apply Service "powershell_check_ntp" {
  check_command = "powershell-checkTime-sync"

  import "powershell-template-service"

  vars.powershell_ntp_server = "de.pool.ntp.org"
  vars.powershell_timeoffset = "10ms"
  vars.powershell_warning = "10ms"
  vars.powershell_critical = "20ms"
  vars.powershell_verbosity = "0"

  assign where host.vars.server_type == "windows"
}
